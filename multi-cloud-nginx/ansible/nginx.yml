---
- name: Installer et configurer Nginx
  hosts: aws
  become: yes
  gather_facts: yes
  vars:
    nginx_port: 80
    
  tasks:
    - name: Attendre que l'instance soit pr√™te
      wait_for_connection:
        timeout: 300
        
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
        
    - name: Installer nginx
      apt:
        name: nginx
        state: present
        
    - name: Cr√©er une page HTML personnalis√©e
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Nginx sur AWS</title>
              <style>
                  body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
                  .container { max-width: 600px; margin: 0 auto; }
                  .success { color: #28a745; }
                  .info { color: #17a2b8; margin: 10px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1 class="success">üéâ Nginx install√© avec succ√®s!</h1>
                  <p class="info">Serveur: {{ inventory_hostname }}</p>
                  <p class="info">Date de d√©ploiement: {{ ansible_date_time.iso8601 }}</p>
                  <p class="info">Distribution: {{ ansible_distribution }} {{ ansible_distribution_version }}</p>
                  <p class="info">D√©ploy√© via GitHub Actions</p>
              </div>
          </body>
          </html>
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: '0644'
        
    - name: Configurer le firewall pour HTTP
      ufw:
        rule: allow
        port: '80'
        proto: tcp
        
    - name: Configurer le firewall pour SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp
        
    - name: Activer le firewall
      ufw:
        state: enabled
        policy: deny
        direction: incoming
        
    - name: D√©marrer et activer nginx
      systemd:
        name: nginx
        state: started
        enabled: true
        daemon_reload: true
        
    - name: V√©rifier le statut de nginx
      systemd:
        name: nginx
      register: nginx_status
      
    - name: Afficher le statut de nginx
      debug:
        msg: "Nginx est {{ nginx_status.status.ActiveState }}"
        
    - name: Attendre que Nginx soit compl√®tement d√©marr√©
      wait_for:
        port: 80
        host: "{{ inventory_hostname }}"
        delay: 5
        timeout: 30
        
    - name: Tester la connectivit√© HTTP locale
      uri:
        url: "http://localhost"
        method: GET
        status_code: 200
      register: local_http_test
      
    - name: Afficher le r√©sultat du test local
      debug:
        msg: "‚úÖ Site accessible localement"
      when: local_http_test.status == 200
      
    - name: Afficher l'URL publique
      debug:
        msg: "üåê Site accessible sur: http://{{ inventory_hostname }}"
