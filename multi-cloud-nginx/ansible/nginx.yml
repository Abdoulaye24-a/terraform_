---
- name: Installer et configurer Nginx
  hosts: aws
  become: yes
  gather_facts: yes
  vars:
    nginx_port: 80
    
  tasks:
    - name: Attendre que l'instance soit pr√™te
      wait_for_connection:
        timeout: 300
        
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
        
    - name: Installer nginx
      apt:
        name: nginx
        state: present
        
    - name: Cr√©er une page HTML personnalis√©e
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Nginx sur AWS</title>
              <style>
                  body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
                  .container { max-width: 600px; margin: 0 auto; }
                  .success { color: #28a745; }
                  .info { background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1 class="success">üéâ Nginx install√© avec succ√®s!</h1>
                  <div class="info">
                      <p><strong>Serveur:</strong> {{ inventory_hostname }}</p>
                      <p><strong>IP Publique:</strong> {{ ansible_default_ipv4.address }}</p>
                      <p><strong>Date de d√©ploiement:</strong> {{ ansible_date_time.iso8601 }}</p>
                      <p><strong>Distribution:</strong> {{ ansible_distribution }} {{ ansible_distribution_version }}</p>
                      <p><strong>Architecture:</strong> {{ ansible_architecture }}</p>
                  </div>
                  <p>üöÄ D√©ploy√© automatiquement avec Terraform + Ansible</p>
              </div>
          </body>
          </html>
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: '0644'
        
    - name: Configurer le firewall pour HTTP
      ufw:
        rule: allow
        port: '80'
        proto: tcp
        
    - name: Configurer le firewall pour SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp
        
    - name: Activer le firewall
      ufw:
        state: enabled
        policy: deny
        direction: incoming
        
    - name: D√©marrer et activer nginx
      systemd:
        name: nginx
        state: started
        enabled: true
        daemon_reload: true
        
    - name: V√©rifier le statut de nginx
      systemd:
        name: nginx
      register: nginx_status
      
    - name: Afficher le statut de nginx
      debug:
        msg: "Nginx est {{ nginx_status.status.ActiveState }}"
        
    - name: Attendre que nginx soit disponible
      wait_for:
        port: 80
        host: "{{ ansible_default_ipv4.address }}"
        delay: 5
        timeout: 60
      delegate_to: localhost
      
    - name: Tester la connectivit√© HTTP avec l'IP r√©elle
      uri:
        url: "http://{{ ansible_default_ipv4.address }}"
        method: GET
        status_code: 200
        timeout: 30
      delegate_to: localhost
      register: http_test
      retries: 3
      delay: 5
      
    - name: Afficher le r√©sultat du test
      debug:
        msg: "‚úÖ Site accessible sur http://{{ ansible_default_ipv4.address }}"
      when: http_test.status == 200
      
    - name: Afficher les informations finales
      debug:
        msg: 
          - "üéâ D√©ploiement termin√© avec succ√®s !"
          - "üåê URL du site: http://{{ ansible_default_ipv4.address }}"
          - "üîë Connexion SSH: ssh -i ~/.ssh/aws.pem ubuntu@{{ ansible_default_ipv4.address }}"
